name: Create All Historical Releases

on:
  workflow_dispatch:

jobs:
  create-historical-releases:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    strategy:
      matrix:
        include:
          - version: '1.7.3'
            previous: '1.7.0'
          - version: '1.8.0'
            previous: '1.7.3'
          - version: '1.8.1'
            previous: '1.8.0'
          - version: '1.8.2'
            previous: '1.8.1'
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: master
      
      - name: Check if tag already exists
        id: check_tag
        run: |
          VERSION="${{ matrix.version }}"
          if git rev-parse "refs/tags/$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists"
            echo "tag_exists=true" >> $GITHUB_OUTPUT
          else
            echo "Tag $VERSION does not exist"
            echo "tag_exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Create tag if it doesn't exist
        if: steps.check_tag.outputs.tag_exists == 'false'
        run: |
          VERSION="${{ matrix.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create tag at current master HEAD
          # Note: These versions were already released to Maven Central
          # We're creating the tag retroactively for documentation purposes
          git tag -a "$VERSION" -m "Release version $VERSION (Maven Central)"
          git push origin "$VERSION"
          
          echo "Created and pushed tag $VERSION"
      
      - name: Wait for tag to propagate
        if: steps.check_tag.outputs.tag_exists == 'false'
        run: sleep 5
      
      - name: Get previous tag info
        id: get_previous
        run: |
          PREVIOUS="${{ matrix.previous }}"
          
          # Check if previous version tag exists
          if git rev-parse "refs/tags/$PREVIOUS" >/dev/null 2>&1; then
            echo "previous_tag=$PREVIOUS" >> $GITHUB_OUTPUT
            echo "Using specified previous version: $PREVIOUS"
          else
            # Use 1.7.0 as fallback since we know it exists
            echo "previous_tag=1.7.0" >> $GITHUB_OUTPUT
            echo "Using 1.7.0 as fallback"
          fi
      
      - name: Build Changelog
        id: build_changelog
        run: |
          CURRENT_VERSION="${{ matrix.version }}"
          PREVIOUS_TAG="${{ steps.get_previous.outputs.previous_tag }}"
          CURRENT_TAG="${{ matrix.version }}"
          
          echo "Generating changelog from $PREVIOUS_TAG to $CURRENT_TAG"
          
          # Create changelog file
          CHANGELOG_FILE=$(mktemp)
          
          # Header with note about retroactive release
          echo "## What's Changed" > $CHANGELOG_FILE
          echo "" >> $CHANGELOG_FILE
          echo "_This is a retroactive release creation. Version $CURRENT_VERSION was published to Maven Central but did not have a GitHub Release._" >> $CHANGELOG_FILE
          echo "" >> $CHANGELOG_FILE
          
          # Get commits between tags/versions if available
          if git rev-parse "refs/tags/$CURRENT_TAG" >/dev/null 2>&1 && git rev-parse "refs/tags/$PREVIOUS_TAG" >/dev/null 2>&1; then
            git log ${PREVIOUS_TAG}..${CURRENT_TAG} --pretty=format:"* %s (%h)" --no-merges >> $CHANGELOG_FILE 2>/dev/null || echo "* Changes published to Maven Central" >> $CHANGELOG_FILE
          else
            echo "* Version published to Maven Central" >> $CHANGELOG_FILE
          fi
          
          echo "" >> $CHANGELOG_FILE
          echo "" >> $CHANGELOG_FILE
          
          # Add Maven Central info
          echo "## Maven Central" >> $CHANGELOG_FILE
          echo "" >> $CHANGELOG_FILE
          echo "This version is available on Maven Central:" >> $CHANGELOG_FILE
          echo "" >> $CHANGELOG_FILE
          echo '```xml' >> $CHANGELOG_FILE
          echo '<dependency>' >> $CHANGELOG_FILE
          echo '    <groupId>com.github.dhorions</groupId>' >> $CHANGELOG_FILE
          echo '    <artifactId>boxable</artifactId>' >> $CHANGELOG_FILE
          echo "    <version>${CURRENT_VERSION}</version>" >> $CHANGELOG_FILE
          echo '</dependency>' >> $CHANGELOG_FILE
          echo '```' >> $CHANGELOG_FILE
          
          echo "" >> $CHANGELOG_FILE
          
          # Add link to Maven Central
          echo "View on [Maven Central](https://central.sonatype.com/artifact/com.github.dhorions/boxable/${CURRENT_VERSION})" >> $CHANGELOG_FILE
          
          # Output the changelog for debugging
          echo "=== Generated Changelog ==="
          cat $CHANGELOG_FILE
          echo "==========================="
          
          # Set output for next step
          echo "changelog_file=$CHANGELOG_FILE" >> $GITHUB_OUTPUT
      
      - name: Check if release already exists
        id: check_release
        run: |
          VERSION="${{ matrix.version }}"
          if gh release view "$VERSION" > /dev/null 2>&1; then
            echo "Release $VERSION already exists"
            echo "release_exists=true" >> $GITHUB_OUTPUT
          else
            echo "Release $VERSION does not exist"
            echo "release_exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create Release
        if: steps.check_release.outputs.release_exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ matrix.version }}
          name: Boxable ${{ matrix.version }}
          body_path: ${{ steps.build_changelog.outputs.changelog_file }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Release created
        if: steps.check_release.outputs.release_exists == 'false'
        run: |
          echo "✅ Successfully created release for version ${{ matrix.version }}"
      
      - name: Release already existed
        if: steps.check_release.outputs.release_exists == 'true'
        run: |
          echo "ℹ️ Release for version ${{ matrix.version }} already exists, skipping"
